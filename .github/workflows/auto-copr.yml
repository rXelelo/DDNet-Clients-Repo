name: Build in COPR
on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to build (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string

jobs:
  build-copr:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y copr-cli rpmdevtools rpm-build

      - name: Configure copr-cli
        run: |
          mkdir -p ~/.config
          cat > ~/.config/copr <<EOF
          [copr-cli]
          login = ${{ secrets.COPR_LOGIN }}
          username = ${{ secrets.COPR_USERNAME }}
          token = ${{ secrets.COPR_TOKEN }}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Get package list
        id: packages
        run: |
          if [[ "${{ inputs.packages }}" == "all" ]]; then
            packages=$(ls SPEC/*.spec | xargs -n1 basename | sed 's/.spec$//' | tr '\n' ' ')
          else
            packages=$(echo "${{ inputs.packages }}" | tr ',' ' ')
          fi
          echo "list=$packages" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building packages: $packages"

      - name: Build SRPMs and submit to COPR
        run: |
          success=()
          failed=()
          mkdir -p SRPMS

          for package in ${{ steps.packages.outputs.list }}; do
            echo "::group::Building $package"
            echo "ðŸ“¥ Fetching sources for $package..."

            spectool -g -C SPEC/ SPEC/${package}.spec

            echo "ðŸ”¨ Building SRPM for $package..."
            rpmbuild -bs SPEC/${package}.spec \
              --define "_sourcedir $(pwd)/SPEC" \
              --define "_srcrpmdir $(pwd)/SRPMS"

            srpm=$(ls SRPMS/${package}*.src.rpm 2>/dev/null | head -1)

            if [ -z "$srpm" ]; then
              echo "âŒ Failed to build SRPM for $package"
              failed+=("$package")
              echo "::endgroup::"
              continue
            fi

            echo "ðŸ“¤ Submitting $srpm to COPR..."
            if copr-cli build rxelelo/ddnet-clients "$srpm"; then
              echo "âœ… $package submitted successfully"
              success+=("$package")
            else
              echo "âŒ $package submission failed"
              failed+=("$package")
            fi

            echo "::endgroup::"
          done

          echo "SUCCESSFUL_BUILDS=${success[*]}" >> $GITHUB_ENV
          echo "FAILED_BUILDS=${failed[*]}" >> $GITHUB_ENV

          if [ ${#failed[@]} -gt 0 ]; then
            exit 1
          fi

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ COPR Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** rxelelo/ddnet-clients" >> $GITHUB_STEP_SUMMARY
          echo "**Requested packages:** ${{ steps.packages.outputs.list }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$SUCCESSFUL_BUILDS" ]; then
            echo "### âœ… Successfully submitted:" >> $GITHUB_STEP_SUMMARY
            for pkg in $SUCCESSFUL_BUILDS; do
              echo "- $pkg" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$FAILED_BUILDS" ]; then
            echo "### âŒ Failed to submit:" >> $GITHUB_STEP_SUMMARY
            for pkg in $FAILED_BUILDS; do
              echo "- $pkg" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ”— [View builds in COPR](https://copr.fedorainfracloud.org/coprs/rxelelo/ddnet-clients/builds/)" >> $GITHUB_STEP_SUMMARY
